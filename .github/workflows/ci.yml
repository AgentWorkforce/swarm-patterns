name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUNDLE_SIZE_LIMIT_KB: 80

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Svelte check
        run: pnpm check

      - name: Lint
        run: pnpm lint

      - name: Build
        run: pnpm build

      - name: Check bundle size
        run: |
          # Check client bundle specifically (not server/prerender artifacts)
          if [ -d "build/_app/immutable/js" ]; then
            CLIENT_DIR="build/_app/immutable"
          elif [ -d ".svelte-kit/output/client/_app/immutable" ]; then
            CLIENT_DIR=".svelte-kit/output/client/_app/immutable"
          else
            echo "Client bundle not found, checking fallback paths..."
            CLIENT_DIR=$(find . -path "*/client/_app/immutable" -type d 2>/dev/null | head -1)
            if [ -z "$CLIENT_DIR" ]; then
              echo "::warning::Could not locate client bundle directory"
              exit 0
            fi
          fi

          echo "Checking client bundle at: $CLIENT_DIR"

          # Calculate JS bundle size (client assets only)
          JS_SIZE=$(find "$CLIENT_DIR" -name "*.js" -type f -exec gzip -c {} \; | wc -c)
          JS_KB=$((JS_SIZE / 1024))

          # Calculate CSS bundle size
          CSS_SIZE=$(find "$CLIENT_DIR" -name "*.css" -type f -exec gzip -c {} \; | wc -c)
          CSS_KB=$((CSS_SIZE / 1024))

          TOTAL_KB=$((JS_KB + CSS_KB))

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Bundle Size Report (gzipped)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  JS:    ${JS_KB}KB"
          echo "  CSS:   ${CSS_KB}KB"
          echo "  Total: ${TOTAL_KB}KB"
          echo "  Limit: ${BUNDLE_SIZE_LIMIT_KB}KB"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          if [ $JS_KB -gt $BUNDLE_SIZE_LIMIT_KB ]; then
            echo "::error::JS bundle ${JS_KB}KB exceeds limit of ${BUNDLE_SIZE_LIMIT_KB}KB"
            exit 1
          else
            echo "::notice::JS bundle ${JS_KB}KB is within ${BUNDLE_SIZE_LIMIT_KB}KB limit ✓"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build/
          retention-days: 7

  lighthouse:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Serve and audit
        run: |
          npx serve build -l 3000 &
          sleep 3
          lhci autorun --collect.url=http://localhost:3000 --assert.preset=lighthouse:recommended || true

      - name: Performance thresholds
        run: |
          echo "Target Core Web Vitals:"
          echo "  - LCP < 2.5s"
          echo "  - FID < 100ms"
          echo "  - CLS < 0.1"
